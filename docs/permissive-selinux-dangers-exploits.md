# PSA:小心安装任何 SELinux 设置为许可的东西

> 原文：<https://www.xda-developers.com/permissive-selinux-dangers-exploits/>

在 Android modding 的世界里，人们倾向于把 root 访问视为一切的基石。它允许用户完全控制他们的设备，并添加在普通配置中不总是可用的功能。但正如他们所说的那样——“伴随着巨大的权力而来的是巨大的责任”——绕过 Android 的安全模式是不明智的，除非你知道你将面临什么。对于我们论坛上的资深 Android 爱好者来说，你可能知道你的设备上存在后门的可能性，并且你更有可能在具有最新安全补丁的最新 Android 版本上运行可信的 root 启用的 mod。话虽如此，你可能知道有几个人并不真正关心他们安装了什么根调整，只要他们看起来为他们工作。这就是为什么你仍然可以找到一卡车的 mod，这些 mod 只有在 SELinux 被设置为 permissive 时才起作用，这反过来使它们的用户极易受到安全威胁。

## 什么是 SELinux

SELinux，或称[安全增强的 Linux](https://en.wikipedia.org/wiki/Security-Enhanced_Linux) ，是一个专门为访问和管理安全策略而设计的 Linux 内核安全模块。SELinux 最初是在 Android 4.3 Jelly Bean 中引入的，并从 Android 4.4 KitKat 开始设置为默认的强制模式，它有助于强制执行访问控制权限，并试图防止权限提升攻击。简而言之，SELinux 充当了对您的设备进行未授权控制的障碍，例如旨在恶意获取 root 访问权限的应用程序或漏洞。默认情况下，将 SELinux 设置为“Enforcing”是保护普通用户免受此类攻击的主要方法之一。

## 为什么不推荐许可 SELinux

重申一下，在 Android 设备上实现 root 访问的典型方法不一定需要更改 SELinux 状态。将 SELinux 模式从“强制”切换到“允许”是有意禁用设备上的一个关键安全功能，这就是为什么用户必须通过安装专门的自定义内核或修改现有引导映像的参数来明确允许这种情况发生。缺乏适当的 SELinux 策略的糟糕编码的 mod 通常会迫使最终用户转向许可的 SELinux，并且实质上扩大了攻击面。这正是开发者 [vvb2060](https://github.com/vvb2060) 展示的，他们[发布了一个概念证明特权提升方法](https://github.com/vvb2060/Magica)，其中获得控制权的唯一要求是许可 SELinux。

## Enter Magica

对于一个运行 Android 10(或更高版本)并把 SELinux 设置为 permissive 的用户来说，在他们自己的设备上获得完全的 root 访问权限非常容易:你所要做的就是按下 install,“玛奇卡”会自动获得一个服务的 root 访问权限，并把 Magisk 安装到启动映像中。这不仅仅是调整你的设备。根据 XDA 资深公认开发人员和 Magisk 维护人员 [topjohnwu](https://forum.xda-developers.com/m/topjohnwu.4470081/) 的说法，任何任意应用程序，包括恶意软件，**都可以通过利用 PoC，在未经您同意和许可的情况下永久扎根您的设备**。

如果你想知道玛奇卡在技术层面上利用了什么，topjohnwu 在 Reddit 帖子中解释了以下内容:

> #### “当 SELinux 在引导期间被许可时，zygote 将知道这一点并禁用 seccomp syscall 过滤器。这基本上不限制第三方进程中允许的系统调用。

> #### 在 Android 10+上，有一个新的“未记录”功能，称为“App Zygote”，允许第三方应用为“隔离服务”产生自己的 Zygote(也几乎没有记录)。“App Zygote”和“独立服务”都是专为 Chrome/Webview*设计的特殊功能。App Zygote 进程使用特殊权限运行，在禁用 seccomp 的情况下，它可以调用 setuid 0 并提升其权限，从而获得 root 访问权限。

> #### 与普通的根解决方案(例如 Magisk)相比，它仍然有一定的限制，但是当 UID=0 时，Android 中的大量安全措施将完全失效。例如，它足以用于修补启动映像，这意味着它可以用于注入修改后的 Magisk 等恶意软件，以帮助其获得“真正的”root 权限。

> #### 更新:UID=0 本身能做什么？在 Android 的框架内，当请求进程的 UID 为 0 时，几乎所有的服务都有一个盲目的绿灯。这意味着这个根进程能够使用 Android 特定的 API(例如 ActivityManager)操纵大量的东西。”

*根据开发人员 avira XP T1 的说法，这两个特性通常是为“在多个独立进程之间共享资源和内存”而设计的

## 结论

考虑到在一个宽容的 SELinux 环境中，恶意软件可能会对用户造成不可挽回的伤害，我们强烈建议每个人都坚持使用它，除非绝对必要。虽然我们只是幸运地拥有一个概念利用的证明，但我们不知道有多少恶意软件作者已经知道这种攻击途径。毕竟，如果受害者没有看到漏洞被积极利用，他们将继续保持对其设备受损状态的遗忘，这对于具有持续根访问权限的流氓应用程序来说并不难实现。