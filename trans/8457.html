<html>
<head>
<title>Android 12's new background app limitations could be a major headache for power users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Android 12 新的后台应用程序限制可能是高级用户的一个主要头痛问题</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/android-12-background-app-limitations-major-headache/#0001-01-01">https://www.xda-developers.com/android-12-background-app-limitations-major-headache/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p>Android 12 引入了很多变化，尽管并不是所有的变化都是面向用户的。像你重新设计的大块材料这样的功能显然摆在你面前，很难错过，但像<a href="https://www.xda-developers.com/google-preps-digital-car-key-support-with-latest-play-services-update/">数字车钥匙</a>支持这样的东西可能更容易错过。然而，一个甚至可能完全没有记录的变化将对 Termux 这样的应用程序造成严重破坏，那就是引入了一个非常激进的后台进程杀手。</p>

  
<p>对于上下文来说，Termux 是一个 Linux 终端模拟器，你可以在 Android 上获得，Termux 的包管理系统很像 Debian 的高级包工具(APT)，因为你可以用命令<em> apt </em>搜索、安装和卸载。Termux 只安装一些开箱即用的基本软件包，以减少 Play Store 上 APK 的大小，但允许你<a href="https://github.com/termux/termux-packages/tree/master/packages">安装任何你想要的额外软件包</a>。人们通常会利用 Termux 将旧智能手机变成迷你服务器，或者用它来运行其他通常不针对智能手机的程序。一种常见的用法甚至是本机设置 youtube-dl，因为您可以在智能手机上使用 Termux 执行 Python 脚本。</p>

<p>然而，在 Android 12 中，<a href="https://github.com/termux/termux-app/issues/2366#issuecomment-955111262">发现</a>引入了一种机制来监控由应用程序启动的分叉子进程，如果应用程序在后台消耗过多 CPU，就会杀死它们(通过<a href="https://twitter.com/MishaalRahman/status/1454539588198932489">米沙勒·拉赫曼</a>)。它还将父进程可以产生的子进程数量限制在 32 个，这极大地限制了应用程序可以在后台完成的操作数量。这个 32 个子进程的限制实际上是跨整个系统的，而不仅仅是每个应用程序，这意味着其他具有子进程的应用程序也会影响这个限制。我在谷歌 Pixel 6 Pro 上进行了测试，我可以确认<em>幻象进程杀手</em>存在，并可能对 Termux 造成严重破坏。</p>

 
<h2 id="android-12-s-phantom-process-killer-kills-background-processes">Android 12 的幻影进程黑仔杀死后台进程</h2>
<p>Android 12 对后台进程引入了一些限制；第一个是，如果父进程也在后台，后台消耗太多 CPU 的应用程序的子进程将被杀死。引入的第二个限制是对在任何给定时间都可以处于活动状态的子进程数量的限制。从<a href="https://cs.android.com/android/_/android/platform/frameworks/base/+/157550849f0430181fa53c8e1b63112c59c6937b">提交历史</a>来看，谷歌似乎试图取缔流氓后台进程。</p>

<p><em>"应用程序可以使用 Runtime.exec()来产生子进程，而框架不知道它的生命周期。现在，只要我们发现这些进程，就跟踪它们——目前在 cpu 统计数据采样期间，它们可能会被发现。如果它消耗了太多的 CPU，而它的父应用程序进程也在后台，杀死它。默认情况下，我们允许多达 32 个这样的进程；其父母的 oom adj 分数最差的进程如果太多就会被杀死。”</em></p>

<p>当然，Android 智能手机已经因为后台 app 查杀而臭名昭著。几乎所有主要的原始设备制造商都以某种方式、形式参与其中，像一加、三星和小米这样的公司被认为是最差的。虽然 AOSP 有一些后台应用程序限制，但制造商通常会在 AOSP 的基础上建立自己的限制。然而，这些对于高级用户来说是非常严格的限制，并且鼓励了高级用户长期以来一直反对的行为。也许从长远来看，它会延长电池寿命，但似乎也没有办法禁用它。</p>
<p class="ad-odd"> </p>


<h2 id="triggering-the-android-12-phantom-process-killer">触发 Android 12 幻影进程黑仔</h2>
<p>正如 commit 所说，允许 32 个这样的进程，我在我的 Google Pixel 6 Pro 上用下面的命令验证了这一点。</p>

<pre> <code class="hljs javascript">adb shell <span class="hljs-string">"/system/bin/dumpsys activity settings"</span></code> </pre>
<p>在这个命令的输出中，有一个名为“max_phantom_processes”的常量，值为 32。在这种情况下,“幻影进程”被 Android 系统判断为在后台运行的子进程。如果你有一个 Android 12 设备，你可以使用 Termux 生成超过 32 个子进程，方法是在你的存储器上创建一个包含以下代码的 bash 脚本并执行它(感谢 GitHub 上的<a href="https://github.com/agnostic-apollo"> agnostic-apollo </a>，一个 Termux 的开发者):</p>

<pre> <code class="hljs javascript"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(seq <span class="hljs-number">40</span>); <span class="hljs-keyword">do</span><br/>sha256sum /dev/zero &amp;<br/><span class="hljs-keyword">done</span></code> </pre>
<p>要执行它，请在 Termux 中导航到保存脚本的文件夹，并键入以下内容:</p>

<pre> <code class="hljs css"><span class="hljs-selector-tag">sh</span> <span class="hljs-selector-tag">filename</span><span class="hljs-selector-class">.sh</span></code> </pre>
<p>如果你的手机开始感觉迟缓，那么这意味着它的工作。上面的代码在后台生成 40 个 sha256sum 操作(用&amp;符号表示)，将<em> /dev/zero </em>文件作为输入。sha256sum 将给出作为输入给出的任何文件的 SHA-256 散列。使用<em> /dev/zero </em>的原因是，它是一个无限长的文件，只要被读取，它就包含空值，这意味着 sha256sum 操作永远不会到达文件的末尾，这是一个很好的压力测试，可以确保连续的后台操作。</p>

<p>几秒到一分钟后，您可能会看到以下内容:</p>



<p>“信号 9”是发送给进程的一个信号，强制它关闭，这个信号是由 Linux 调度程序发送的。出现该消息的原因是 bash 终端在技术上也是 Termux 的子进程，在上面的演示中，Android 12 最终杀死了 bash 终端。在 logcat 输出中，您可以看到以下内容:</p>

<pre> <code class="hljs ">11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {623260a 7362:7284:nightwatch.txt/u0a227}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {bf3d88c 24220:24040:nightwatch.txt/u0a237}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {b160bd5 27316:27269:bash/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {bbc1fea 27371:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {9cf12db 27372:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {54bf178 27373:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {fb89051 27374:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {d3450b6 27375:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {2a201b7 27376:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {60aad24 27377:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {124e08d 27378:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.507 1444 1762 I ActivityManager: Killing PhantomProcessRecord {32cc242 27379:27269:sha256sum/u0a340}: Trimming phantom processes<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {b160bd5 27316:27269:bash/u0a340} died<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {9cf12db 27372:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {414579a 27434:27269:top/u0a340} died<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {32cc242 27379:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {bbc1fea 27371:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.511 1444 1764 I ActivityManager: Process PhantomProcessRecord {bf3d88c 24220:24040:nightwatch.txt/u0a237} died<br/>11-02 13:01:52.512 1444 1764 I ActivityManager: Process PhantomProcessRecord {60aad24 27377:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.516 1444 1764 I ActivityManager: Process PhantomProcessRecord {623260a 7362:7284:nightwatch.txt/u0a227} died<br/>11-02 13:01:52.516 1444 1764 I ActivityManager: Process PhantomProcessRecord {124e08d 27378:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.517 1444 1764 I ActivityManager: Process PhantomProcessRecord {fb89051 27374:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.519 1444 1764 I ActivityManager: Process PhantomProcessRecord {54bf178 27373:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.532 1444 1764 I ActivityManager: Process PhantomProcessRecord {2a201b7 27376:27269:sha256sum/u0a340} died<br/>11-02 13:01:52.545 1444 1764 I ActivityManager: Process PhantomProcessRecord {d3450b6 27375:27269:sha256sum/u0a340} died</code> </pre>
<p>重要的一行是提到“bash”进程被修剪然后死亡，这就是 Termux 停止工作的原因。虽然我不确定“nightwatch.txt”是什么，但粗略的谷歌搜索似乎表明它与脸书和 Facebook Messenger 有关，这两个应用我都安装过。我在自适应电池关闭的情况下进行了测试，并确保没有对 Termux 进行电池优化。</p>

<p>完成测试后，一些 sha256sum 操作可能会继续在后台运行(按 enter 将强制关闭 Termux)，因此重新打开 Termux 并键入以下内容:</p>

<pre> <code class="hljs ">killall sha256sum</code> </pre>
<p>虽然这种限制对一些应用程序来说是有意义的，但高级用户可能更倾向于使用的应用程序(如 Termux)将受到影响。这也可能对高级用户使用的其他应用程序产生影响，如 Tasker。这是一个似乎还不可能克服的限制，并且在制造商施加的所有其他专有限制的基础上，对后台应用程序引入了更多的限制。在正在进行的 GitHub 问题主题中，agnostic-apollo 提到了以下关于发给他们的 logcat 的邮件:</p>

<p/><p>“所有 32 个被跟踪的 logcat PhantomProcessRecord 都属于 com.wsandroid.suite，termux 的 bash 是被终止的进程之一。如上所述，32 个进程的限制适用于所有应用程序的总和”</p>

<p>有趣的是，我在一台运行 Android 11 的小米 11T Pro 上进行了同样的测试，并确认了这种行为在该配置下的特定设备上不存在，尽管小米设备因后台应用程序限制而臭名昭著。奇怪的是，这是任何 Android 智能手机上引入的最严格的后台应用程序管理政策之一，因为没有办法绕过它。即使在小米设备和一加设备上，也有可能禁用大部分的电池优化，对一些人来说，禁用这些设备上的所有电池优化就足够让他们高兴了。相比之下，幻影进程杀手甚至不能被禁用。</p>

<p>如果您依赖 Termux 进行大量的设备上操作，这些操作需要大量的后台进程，那么在获得更多信息之前，暂时推迟升级可能是值得的。如果您不是超级用户，那么这可能不是您真正需要担心的事情。</p>

 </div>


</div>    
</body>
</html>