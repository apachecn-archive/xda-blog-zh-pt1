<html>
<head>
<title>Google's Generic Kernel Image is the next step towards solving Android's fragmentation problem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>谷歌的通用内核映像是解决 Android 碎片问题的下一步</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/google-generic-kernel-image/#0001-01-01">https://www.xda-developers.com/google-generic-kernel-image/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p>谷歌多年来一直致力于减少 Android 上的碎片化，尽管部分原因是 Android 的固有特性以及选择和自由的双刃剑。有无数的原始设备制造商活跃在这个领域，他们都想为自己的设备做出自己的修改。那么问题是，看起来 Android 操作系统更新在全面铺开方面很慢，但谷歌实际上没有太多办法迫使原始设备制造商更新他们的设备。因此，谷歌能做的下一件最好的事情就是让更新过程尽可能的简单和顺畅。</p>

 
<h2 id="easing-the-android-update-pain">缓解 Android 更新的痛苦</h2>
<p>谷歌长期项目中减少开发负担的第一个重大举措是<a href="https://www.xda-developers.com/googles-project-treble-modularize-android-so-oems-can-update-devices-faster/"> Project Treble </a>。该项目于 2017 年与 Android 8.0 Oreo 一起发布，通过将操作系统框架与供应商实现(HALs 和特定于设备的 Linux 内核分叉)分离，实现了三重模块化 Android。这使得 Android OEMs 厂商更容易在最新的 AOSP 框架上重新构建他们的操作系统，因为他们可以启动最新版本，而不需要从供应商那里更新代码。因此，原始设备制造商可以比以前更快地准备好他们的定制 Android 分支，进而更快地推出主要的操作系统更新。</p>

<p>谷歌计划的下一步是简化 Android 关键组件的更新交付。谷歌在 2019 年推出 Android 10 时，将这一举措称为项目主线。谷歌实际上控制了关键的操作系统组件，并禁止原始设备制造商修改它们。然后，他们通过 Google Play 建立了一个交付机制，这样他们就可以远程发布这些关键组件的更新，而不必等待原始设备制造商自己应用补丁。Mainline 大大提高了设备接收重要操作系统组件更新版本的速度，从而提高了整个 Android 生态系统的安全性。</p>

<p>当谈到三倍时，Linux 内核实际上不应该与闭源供应商代码混为一谈。Todd Kjos 在今年的 Linux 管道工会议上解释了 Android 碎片化所面临的困难，现在很多困难都集中在原始设备制造商随设备提供的 Linux 内核上。对于上下文，Google 将每个主线 Linux 内核分成一个“<a href="https://source.android.com/devices/architecture/kernel/android-common"> Android 公共内核</a>”(ACK)分支，该分支密切跟踪主线版本，但添加了一些特定于 Android 的补丁。像高通、联发科和三星这样系统芯片供应商然后为他们生产的每一个系统芯片选择 T4 的 T5 内核。然后，原始设备制造商采用特定于 SoC 的内核，并添加额外的补丁，以实现对他们想要发运的特定硬件的支持。</p>



<p>上图显示了一个设备的内核是如何经历几层变化的，这些变化将它从 Linux LTS 内核中抽象出来。为了简化它，我们从 Linux 内核开始，经过一些修改，它被合并到 Android 通用内核中。从那里，Android 通用内核被合并到一个厂商的内核(高通，联发科等)中，并有自己的修改和变化。最后，厂商内核被合并到 OEM 的设备专用内核中。到了这个阶段，任何一个设备的内核都与它开始时的 Linux LTS 内核相去甚远。</p>

<p>由于所有这些分叉，在 Android 设备上运行的多达 50%的代码是树外代码，这意味着它不是来自上游的 Linux 或 AOSP 通用内核。这使得合并上游变更变得异常困难(更不用说耗时和昂贵了)。对于原始设备制造商来说，没有动机这样做，但这种做法可能对设备安全有害。这也是为什么许多 Android 设备仍然停留在旧的 LTS 内核版本上，其副作用是设备无法获得新的 Linux 内核功能。</p>
<p class="ad-odd"> </p>


<h2 id="android-is-fragmented-and-google-knows-it">Android 是支离破碎的，谷歌知道这一点</h2>
<p>谷歌很清楚这是一个问题，甚至在 Android 开发者文档中有一个名为“<a href="https://source.android.com/devices/architecture/kernel/generic-kernel-image#fragmentation-costs">碎片化成本</a>”的部分。谷歌称<em>“大多数旗舰设备搭载的内核版本至少已经有 18 个月了”</em>。更糟糕的是，谷歌还表示<em>“Android 10 支持 3.18、4.4、4.9、4.14 和 4.19 内核，在某些情况下，自 2017 年 Android 8 以来，这些内核没有得到新功能的增强。”</em>这使得添加需要新 Linux 内核版本的特性变得困难。Linux 内核 3.18 于 2014 年 12 月推出，当时 Android 5.0 Lollipop 是 Android 的最新版本。这显然是一个问题，会阻碍平台的发展。</p>

<p>例如，Code Aurora Forum，简称 CAF，拥有各种高通骁龙 SOC 的源代码。高通作为一家 SoC 供应商，向 OEM/ODM 分发 Linux 内核的分叉版本，然后这些公司在出货设备上添加特定于设备的更改。这就增加了几层分裂。此外，高通对 AOSP 框架进行了修改，以优化该公司骁龙移动平台的安卓系统。高通将其修改后的 Linux 内核、AOSP 框架和其他软件工具私下分发给其合作伙伴，作为董事会支持包(BSP)的一部分。CAF 是高通公开发布这些 Linux 内核变化和 AOSP 框架变化的地方。</p>

<p>这个 CAF 版本对于那些希望把它作为一个起点而不是纯粹的 AOSP 的定制 ROM 开发者来说是有用的，这就是为什么你有时会在我们的论坛上看到<a href="https://forum.xda-developers.com/search/30192493/?q=caf&amp;o=relevance">“基于 CAF”的 ROM。还记得多年来似乎为许多中端智能手机提供动力的骁龙 625 吗？这是随 Linux 内核 3.18 推出的，直到 2018 年底(芯片组推出两年后)，高通才更新了内核源代码，并将其发布在 msm8953(骁龙 625 的芯片组名称)的</a><a href="https://wiki.codeaurora.org/xwiki/bin/QAEP/release">咖啡馆</a>上，从而支持 Linux 内核 4.9。问题是，大多数原始设备制造商不会将手机更新到这个新的 Linux 内核版本，尤其是在芯片发布两年后的中端手机。诚然，像这样的重大内核更新一开始就发生是非常罕见的，但关键是<em>已经</em>发生了，所以这不仅仅是一个不可能的场景。</p>

<p>总而言之，安卓目前的碎片化很乱，说轻一点。谷歌最近试图以通用内核映像或 GKI 的形式解决这一问题。</p>
<p class="ad-even"> </p>


<h2 id="introducing-the-generic-kernel-image">介绍通用内核映像</h2>
<p>为了解决这个问题，谷歌致力于 Android 通用内核映像(GKI)。这本质上是一个直接从 ACK 分支编译而来的内核。GKI 将 SoC 供应商和 OEM 定制隔离到插件模块，消除了树外代码，并允许 Google 将内核更新直接推送到最终用户。一年多来，谷歌一直致力于通过 Play Store、<a href="https://android-review.googlesource.com/c/platform/system/extras/+/1371347">使用主线模块</a>来发布 GKI 更新。</p>

<p>因此，运行 Linux 内核 5.10.43 或更高版本的 Android 12 设备必须做以下事情之一，米沙·拉赫曼说<a href="https://twitter.com/MishaalRahman/status/1460274531038375936">。</a></p>

<ul> <li>部署 Google 签名的启动映像</li> </ul>

<p>运筹学</p>

<ul> <li>使用内核部署引导映像，该内核导出 KMI(内核模块接口),它是 GKI 导出的 KMI 的子集，导出用户空间 API，它是 GKI 公开的 UAPI 的超集，并支持相应 GKI 版本的所有特性</li> </ul>

<p>供应商可以创建插入 GKI 的模块，但是 GKI 的想法是谷歌承担处理内核变化的责任。内核模块接口(或 KMI，在本文后面的部分会有更多介绍)实际上是树外代码应该去的地方。</p>

<p>谷歌 Pixel 6 系列推出了开箱即用的 Android 12，并搭载了 Linux 内核 5.10，这是第一款搭载 GKI 的手机。因为谷歌可能会通过 Play Store 更新内核，我们甚至可能会看到频繁的内核更新，<a href="https://www.kernel.org/category/releases.html">因为 LTS 的内核更新通常每周发布一次</a>。无论哪种方式，这都是一个比目前通过 OTA 更新的繁琐方法好得多的系统，尽管这意味着它与 GMS 框架有着内在的联系。</p>

<p>谷歌对 GKI 的简单定义如下:</p>

<ul> <li>它是根据 ACK 源构建的。</li> <li>它是一个单内核二进制加上相关的每个架构的可加载模块，每个 LTS 版本(目前只有 arm64 用于<code dir="ltr" translate="no">android11-5.4</code>和<code dir="ltr" translate="no">android12-5.4</code>)。</li> <li>它已经过所有支持相关确认的 Android 平台版本的测试。在 GKI 内核版本的生命周期中，没有特性被弃用</li> <li>它向给定 LTS 内的驾驶员展示了稳定的 KMI。</li> <li>它不包含 SoC 或特定于主板的代码。</li> </ul>

<p>谷歌甚至希望到 2023 年能够采取“上游优先”的发展模式。这将有助于谷歌确保新代码首先登陆主流 Linux 内核，减少 Android 设备上树外代码累积的“技术债务”。</p>


<p class="ad-odd"> </p>


<h2 id="the-kernel-module-interface-kmi">内核模块接口(KMI)</h2>
<p>内核模块接口，或称 KMI，是谷歌解决安卓系统碎片化问题的一部分。本质上，SoC 和板支持不再位于核心内核中，而是移到可加载模块中。内核和模块都可以独立更新，因为模块是在<code>/lib/modules</code>中更新的。GKI 本身应该尽可能的干净和通用，这是通过将现在的树外代码卸载到单独的模块中来实现的。</p>

<p>正如 Ted Kjos <a href="https://youtu.be/O_lCFGinFPM?t=2172">在今年的 Linux 管道工会议上解释的那样，“多年来的巨大推动是将所有硬件特定的代码从通用内核中取出，放入供应商模块中。我们必须在这些供应商模块和通用内核之间有一个稳定的接口，以便它们可以异步交付。”GKI 1.0 本质上是一个“合规测试”。</a></p>

<p>事实上，GKI 兼容性意味着设备通过了 VTS 和 CTS-on-GSI+GKI 测试，安装了通用系统映像(GSI)和 GKI 内核，方法是将 GKI 启动映像刷新到启动分区，GSI 系统映像刷新到系统分区。供应商测试套件(VTS)是一种自动化测试，所有设备都必须通过该测试，才能被视为与 Project Treble 兼容。要访问谷歌的应用程序套件，需要兼容性测试套件(CTS)。</p>

<p>设备可以附带不同的产品内核，并可以使用 GKI 不提供的可加载模块。然而，产品和 GKI 内核都必须从相同的 vendor_boot 和 vendor 分区加载模块。因此，所有产品内核都需要有相同的二进制内核模块接口(KMI)。</p>



<p>上图显示了 Google <em>希望</em>做什么，并解释了它打算如何实现这一目标。通用内核和 GKI 模块将是 AOSP 的一部分，GKI 可以与 Android 框架和供应商可能实现的硬件抽象层(HAL)进行通信。供应商希望在内核中包含的特定专有代码(例如，相机驱动程序)将被推入供应商模块，该模块通过 KMI 成为 GKI 的扩展。</p>
<p class="ad-even"> </p>


<h2 id="how-the-gki-can-help-solve-android-s-fragmentation-problem">GKI 如何帮助解决 Android 的碎片问题</h2>
<p>谷歌一直在简化智能手机的开发流程方面投入大量工作。每个 OEM 都希望拥有自己的品牌身份，每个 OEM 都希望能够拥有自己的设备。与 Android One 计划不同，Android 智能手机几乎可以成为他们想要的任何东西，只要他们遵守谷歌为获得 GMS 许可证而制定的一套规则。然而，在过去，谷歌并没有为统治 Android 设备开发做很多事情，像 Project Treble、Mainline 和现在的 GKI 这样的变化在 Android 的历史上要近得多。</p>

<p>但是会有帮助吗？应该是这样的，尽管这可能是一个多年的事情，在未来会结出明显的果实。这将只适用于搭载 Android 12 的设备，这意味着我们将在未来几年看到没有 GKI 的设备。宣布 Treble 项目时，这也是对它的批评，尽管显然现在推出的所有设备都支持它。这些事情需要时间，随着谷歌慢慢占据 Android 的统治地位，Android 生态系统中的所有 OEM 厂商的开发过程都变得容易了，即使其中一些厂商宁愿保留对 Android 智能手机上使用的 Linux 内核的完全控制。</p>

 </div>


</div>    
</body>
</html>